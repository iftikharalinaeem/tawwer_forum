function KeenIOWidget(e){var t=null,n={},i=null,r=[],a=null,o="daily",u=null,s=[],f={end:null,start:null},l=null,h="";this.addQuery=function(e){if(e instanceof Array)for(var t=0;t<e.length;t++)this.addQuery(e[t]);else if("object"==typeof e){var n={eventCollection:e.eventCollection||null,filters:e.filters||[],maxAge:86400};"undefined"!=typeof e.groupBy&&(n.groupBy=e.groupBy),"undefined"!=typeof e.target_property&&(n.target_property=e.target_property);var i=new Keen.Query(e.analisysType||null,n);i.title=e.title||null,s.push(i)}},this.getCallback=function(){return t},this.getClient=function(){if(null===i&&"function"==typeof Keen){var e=gdn.meta["keenio.projectID"]||!1,t=gdn.meta["keenio.readKey"]||!1;i=new Keen({projectId:e,readKey:t})}return i},this.getConfig=function(e,t){return"undefined"==typeof n[e]?t||null:n[e]},this.getData=function(){return r},this.getDataviz=function(){return null===a&&(a=new Keen.Dataviz,this.loadDatavizConfig(this.getConfig())),a},this.getElement=function(){return u},this.getInterval=function(){return o},this.getRange=function(){return f},this.getQuery=function(){return s},this.getQueryParam=function(e,t){var n=this.getQuery();if(t="undefined"==typeof t?0:parseInt(t),"undefined"==typeof n[t])throw"Invalid query index";var i=n[t];return i.get(e)},this.getTitle=function(){return h},this.getType=function(){return l},this.resetQuery=function(){s=[]},this.setCallback=function(e){if("function"==typeof this[e])return t=this[e],this;throw"Invalid value for newCallback"},this.setData=function(e){if("undefined"!=typeof e)return r=e,this;throw"Invalid newData"},this.setElement=function(e){if(e instanceof HTMLElement)return u=e,this;throw"newElement is not an instance of HTMLElement"},this.setInterval=function(e){if("string"==typeof e)return o=e,this;throw"newInterval must be a string"},this.setRange=function(e){if("object"!=typeof e)throw"Invalid newRange";var t=e.rangeEnd||!1,n=e.rangeEnd||!1;return"object"==typeof t&&t instanceof Date?f.end=t:(f.end=new Date,f.end.setHours(0,0,0)),"object"==typeof n&&n instanceof Date?f.start=n:(f.start=new Date,f.start.setHours(0,0,0),f.start.setMonth(f.end.getMonth()-1)),this},this.setType=function(e){if("string"==typeof e)return l=e,this;throw"Invalid newType"},this.setTitle=function(e){if("string"==typeof e)return h=e,this;throw"Invalid newTitle"},this.updateQueryParams=function(e){if("object"!=typeof e)throw"Invalid newParams";for(var t=0;t<s.length;t++)s[t].set(e)},this.loadConfig(e)}KeenIOWidget.prototype.divideResult=function(e){var t=[];if(!Array.isArray(e))throw"divideResult requires an array";if(2!==e[0].value.length)throw"divideResult requires exactly two results";for(var n=0;n<e.length;n++){var i;i=e[n].value[1].result>0?parseFloat((e[n].value[0].result/e[n].value[1].result).toFixed(2)):0,t.push({timeframe:e[n].timeframe,value:i})}return t},KeenIOWidget.prototype.loadConfig=function(e){if("object"!=typeof e)throw"Invalid config";"undefined"!=typeof e.chartConfig&&this.setChartConfig(e.chartConfig),"undefined"!=typeof e.query&&(this.resetQuery(),this.addQuery(e.query)),"undefined"!=typeof e.range&&this.setRange(e.range),"undefined"!=typeof e.title&&this.setTitle(e.title),"undefined"!=typeof e.type&&this.setType(e.type)},KeenIOWidget.prototype.loadDatavizConfig=function(e){var t=this.getDataviz();t.library("c3"),t.chartType(this.getConfig("type","")),t.chartOptions(this.getConfig("options",{}))},KeenIOWidget.prototype.renderBody=function(){var e=this.getDataviz(),t=e.el();if(!("object"==typeof t&&t instanceof HTMLElement))throw"No valid dataviz element";switch(this.getType()){case"metric":t.innerHTML=this.getData()+" "+this.getTitle();break;default:e.parseRawData({result:this.getData()}),e.render()}},KeenIOWidget.prototype.runQuery=function(e){var t=this.getClient(),n=this,i={timeframe:this.getRange()};"metric"!==this.getType()&&(i.interval=this.getInterval()),this.updateQueryParams(i);var r=this.getQuery();t.run(r,function(t,i){if(null===t){var a=n.getQueryResult(i,r);if(n.setData(a),"function"==typeof e){var o=e.bind(n);o()}}})},KeenIOWidget.prototype.getQueryResult=function(e,t){var n=this.getCallback(),i=[];if("undefined"!=typeof e&&"undefined"!=typeof t)if(Array.isArray(e)&&e.length>0){var r=e.shift().result;if(e.length>=1)for(var a=0;a<r.length;a++){var o=[];o.push({category:t[0].title,result:r[a].value});for(var u=0;u<e.length;u++){var s=u+1;o.push({category:t[s].title,result:e[u].result[a].value})}i.push({timeframe:r[a].timeframe,value:o})}else i=r,i.category=t[0].title}else"object"==typeof e&&"undefined"!=typeof e.result&&(Array.isArray(e.result)?(i=e.result,i.category=t[0].title):i=e.result);return n&&(i=n(i)),i},KeenIOWidget.prototype.writeContents=function(e,t){var n=this.getClient(),i=this.getDataviz();if(t="undefined"==typeof t?!1:!!t,"object"==typeof n){var r=i.el();(t||"object"!=typeof r&&!(r instanceof HTMLElement))&&i.el(e),i.prepare(),this.runQuery(this.renderBody)}};