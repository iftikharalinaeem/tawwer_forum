function KeenIOWidget(a){var b=null,c={},d=null,e=[],f=null,g="daily",h=null,i=[],j={end:null,start:null},k=null,l="";this.addQuery=function(a){if(a instanceof Array)for(var b=0;b<a.length;b++)this.addQuery(a[b]);else if("object"==typeof a){var c={eventCollection:a.eventCollection||null,maxAge:86400};"undefined"!=typeof a.filters&&Array.isArray(a.filters)&&a.filters.length>0&&(c.filters=a.filters),"undefined"!=typeof a.groupBy&&null!==a.groupBy&&(c.groupBy=a.groupBy),"undefined"!=typeof a.target_property&&(c.target_property=a.target_property);var d=new Keen.Query(a.analisysType||null,c);d.title=a.title||null,i.push(d)}},this.getCallback=function(){return b},this.getClient=function(){if(null===d&&"function"==typeof Keen){var a=gdn.meta["keenio.projectID"]||!1,b=gdn.meta["keenio.readKey"]||!1;d=new Keen({projectId:a,readKey:b})}return d},this.getConfig=function(a,b){return"undefined"==typeof c[a]?b||null:c[a]},this.getData=function(){return e},this.getDataviz=function(){return null===f&&(f=new Keen.Dataviz,this.loadDatavizConfig(this.getConfig())),f},this.getElement=function(){return h},this.getInterval=function(){return g},this.getRange=function(){return j},this.getQuery=function(){return i},this.getQueryParam=function(a,b){var c=this.getQuery();if(b="undefined"==typeof b?0:parseInt(b),"undefined"==typeof c[b])throw"Invalid query index";var d=c[b];return d.get(a)},this.getTitle=function(){return l},this.getType=function(){return k},this.resetQuery=function(){i=[]},this.setCallback=function(a){if("function"==typeof this[a])return b=this[a],this;throw"Invalid value for newCallback"},this.setData=function(a){if("undefined"!=typeof a)return e=a,this;throw"Invalid newData"},this.setElement=function(a){if(a instanceof HTMLElement)return h=a,this;throw"newElement is not an instance of HTMLElement"},this.setInterval=function(a){if("string"==typeof a)return g=a,this;throw"newInterval must be a string"},this.setRange=function(a){if("object"!=typeof a)throw"Invalid newRange";var b=a.end||!1,c=a.start||!1;return"object"==typeof b&&b instanceof Date?j.end=b:(j.end=new Date,j.end.setHours(0,0,0)),"object"==typeof c&&c instanceof Date?j.start=c:(j.start=new Date,j.start.setHours(0,0,0),j.start.setMonth(j.end.getMonth()-1)),this},this.setType=function(a){if("string"==typeof a)return k=a,this;throw"Invalid newType"},this.setTitle=function(a){if("string"==typeof a)return l=a,this;throw"Invalid newTitle"},this.updateQueryParams=function(a){if("object"!=typeof a)throw"Invalid newParams";for(var b=0;b<i.length;b++)i[b].set(a)},this.loadConfig(a)}KeenIOWidget.prototype.divideResult=function(a){var b=[];if(!Array.isArray(a))throw"divideResult requires an array";if(2!==a[0].value.length)throw"divideResult requires exactly two results";for(var c=0;c<a.length;c++){var d;d=a[c].value[1].result>0?parseFloat((a[c].value[0].result/a[c].value[1].result).toFixed(2)):0,b.push({timeframe:a[c].timeframe,value:d})}return b},KeenIOWidget.prototype.getMetricMarkup=function(){var a='<span class="metric-value">{data}</span><span class="metric-title">{title}</span>',b=this.getData();this.getTitle();return a=a.replace("{data}",Number(b).toLocaleString()),a=a.replace("{title}",this.getTitle())},KeenIOWidget.prototype.loadConfig=function(a){if("object"!=typeof a)throw"Invalid config";"undefined"!=typeof a.chartConfig&&this.setChartConfig(a.chartConfig),"undefined"!=typeof a.query&&(this.resetQuery(),this.addQuery(a.query)),"undefined"!=typeof a.range&&this.setRange(a.range),"undefined"!=typeof a.title&&this.setTitle(a.title),"undefined"!=typeof a.type&&this.setType(a.type)},KeenIOWidget.prototype.loadDatavizConfig=function(a){var b=this.getDataviz();b.library("c3"),b.chartType(this.getConfig("type","area")),b.chartOptions(this.getConfig("options",{})),b.dateFormat("%Y-%m")},KeenIOWidget.prototype.renderBody=function(){var a=this.getDataviz(),b=a.el();if(!("object"==typeof b&&b instanceof HTMLElement))throw"No valid dataviz element";switch($(b).parent().removeClass("data-loading"),this.getType()){case"metric":b.innerHTML=this.getMetricMarkup();break;default:a.parseRawData({result:this.getData()});var c=a.labels();if(c.length>1)a.stacked(!0);else{var d=$(b).parent(".analytics-widget").index(),e=a.colors();a.colors([e[d%e.length]])}for(var f=0;f<c.length;f++)""===c[f]&&(c[f]="(None)");a.labels(c),a.view._rendered?a.update():a.render()}},KeenIOWidget.prototype.runQuery=function(a){var b=this.getClient(),c=this,d={timeframe:this.getRange()};"metric"!==this.getType()&&(d.interval=this.getInterval()),this.updateQueryParams(d);var e=this.getQuery();b.run(e,function(b,d){if(null===b){var f=c.getQueryResult(d,e);if(c.setData(f),"function"==typeof a){var g=a.bind(c);g()}}})},KeenIOWidget.prototype.getQueryResult=function(a,b){var c=this.getCallback(),d=[];if("undefined"!=typeof a&&"undefined"!=typeof b)if(Array.isArray(a)&&a.length>0){var e=a.shift().result;if(a.length>=1)for(var f=0;f<e.length;f++){var g=[];g.push({category:b[0].title,result:e[f].value});for(var h=0;h<a.length;h++){var i=h+1;g.push({category:b[i].title,result:a[h].result[f].value})}d.push({timeframe:e[f].timeframe,value:g})}else d=e,d.category=b[0].title}else"object"==typeof a&&"undefined"!=typeof a.result&&(Array.isArray(a.result)?(d=a.result,d.category=b[0].title):d=a.result);return c&&(d=c(d)),d},KeenIOWidget.prototype.writeContents=function(a,b){var c=this.getClient(),d=this.getDataviz();if(b="undefined"==typeof b?!1:!!b,"object"==typeof c){var e=d.el();!b&&("object"==typeof e||e instanceof HTMLElement)||d.el(a),"metric"==this.getType()&&d.height(100),d.view._prepared===!1&&d.prepare(),$(a).parent().addClass("data-loading"),this.runQuery(this.renderBody)}};
//# sourceMappingURL=keeniowidget.min.js.map