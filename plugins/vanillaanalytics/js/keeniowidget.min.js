function KeenIOWidget(e){var t={},n=null,i=[],r=null,a="daily",o=null,s=[],u={end:null,start:null},f=null,l="";this.addQuery=function(e){if(e instanceof Array)for(var t=0;t<e.length;t++)this.addQuery(e[t]);else if("object"==typeof e){var n={eventCollection:e.eventCollection||null,filters:e.filters||[],maxAge:86400};"undefined"!=typeof e.groupBy&&(n.groupBy=e.groupBy),"undefined"!=typeof e.target_property&&(n.target_property=e.target_property);var i=new Keen.Query(e.analisysType||null,n);i.title=e.title||null,s.push(i)}},this.getClient=function(){if(null===n&&"function"==typeof Keen){var e=gdn.meta["keenio.projectID"]||!1,t=gdn.meta["keenio.readKey"]||!1;n=new Keen({projectId:e,readKey:t})}return n},this.getConfig=function(e,n){return"undefined"==typeof t[e]?n||null:t[e]},this.getData=function(){return i},this.getDataviz=function(){return null===r&&(r=new Keen.Dataviz,this.loadDatavizConfig(this.getConfig())),r},this.getElement=function(){return o},this.getInterval=function(){return a},this.getRange=function(){return u},this.getQuery=function(){return s},this.getQueryParam=function(e,t){var n=this.getQuery();if(t="undefined"==typeof t?0:parseInt(t),"undefined"==typeof n[t])throw"Invalid query index";var i=n[t];return i.get(e)},this.getTitle=function(){return l},this.getType=function(){return f},this.resetQuery=function(){s=[]},this.setData=function(e){if("undefined"!=typeof e)return i=e,this;throw"Invalid newData"},this.setElement=function(e){if(e instanceof HTMLElement)return o=e,this;throw"newElement is not an instance of HTMLElement"},this.setInterval=function(e){if("string"==typeof e)return a=e,this;throw"newInterval must be a string"},this.setRange=function(e){if("object"!=typeof e)throw"Invalid newRange";var t=e.rangeEnd||!1,n=e.rangeEnd||!1;return"object"==typeof t&&t instanceof Date?u.end=t:(u.end=new Date,u.end.setHours(0,0,0)),"object"==typeof n&&n instanceof Date?u.start=n:(u.start=new Date,u.start.setHours(0,0,0),u.start.setMonth(u.end.getMonth()-1)),this},this.setType=function(e){if("string"==typeof e)return f=e,this;throw"Invalid newType"},this.setTitle=function(e){if("string"==typeof e)return l=e,this;throw"Invalid newTitle"},this.updateQueryParams=function(e){if("object"!=typeof e)throw"Invalid newParams";for(var t=0;t<s.length;t++)s[t].set(e)},this.loadConfig(e)}KeenIOWidget.prototype.loadConfig=function(e){if("object"!=typeof e)throw"Invalid config";"undefined"!=typeof e.chartConfig&&this.setChartConfig(e.chartConfig),"undefined"!=typeof e.query&&(this.resetQuery(),this.addQuery(e.query)),"undefined"!=typeof e.range&&this.setRange(e.range),"undefined"!=typeof e.title&&this.setTitle(e.title),"undefined"!=typeof e.type&&this.setType(e.type)},KeenIOWidget.prototype.loadDatavizConfig=function(e){var t=this.getDataviz();t.library("c3"),t.chartType(this.getConfig("type","")),t.chartOptions(this.getConfig("options",{}))},KeenIOWidget.prototype.renderBody=function(){var e=this.getDataviz(),t=e.el();if(!("object"==typeof t&&t instanceof HTMLElement))throw"No valid dataviz element";switch(this.getType()){case"metric":t.innerHTML=this.getData()+" "+this.getTitle();break;default:e.parseRawData({result:this.getData()}),e.render()}},KeenIOWidget.prototype.runQuery=function(e){var t=this.getClient(),n=this.getQuery().slice(0),i=this,r={timeframe:this.getRange()};"metric"!==this.getType()&&(r.interval=this.getInterval()),this.updateQueryParams(r),t.run(n,function(t,r){if(null===t){var a=i.getQueryResult(r,n);i.setData(a),"function"==typeof e&&(boundCallback=e.bind(i),boundCallback())}})},KeenIOWidget.prototype.getQueryResult=function(e,t){var n=[];if("undefined"!=typeof e&&"undefined"!=typeof t)if(Array.isArray(e)&&e.length>0){var i=e.shift();if(e.length>=1)for(var r=0;r<i.length;r++){var a=[];a.push({category:t[0].title,result:i[r].value});for(var o=0;o<e.length;o++){var s=o+1;a.push({category:t[s].value,result:e[s].value})}n.push({timeframe:i.timeframe,value:a})}else n=i,n.category=t[0].title}else"object"==typeof e&&"undefined"!=typeof e.result&&(Array.isArray(e.result)?(n=e.result,n.category=t[0].title):n=e.result);return n},KeenIOWidget.prototype.writeContents=function(e,t){var n=this.getClient(),i=this.getDataviz();if(t="undefined"==typeof t?!1:!!t,"object"==typeof n){var r=i.el();(t||"object"!=typeof r&&!(r instanceof HTMLElement))&&i.el(e),i.prepare(),this.runQuery(this.renderBody)}};