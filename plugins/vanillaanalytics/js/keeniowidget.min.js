function KeenIOWidget(a){var b=null,c={},d=null,e=[],f=null,g="daily",h=null,i=[],j={end:null,start:null},k=null,l="";this.addQuery=function(a){if(a instanceof Array)for(var b=0;b<a.length;b++)this.addQuery(a[b]);else if("object"==typeof a){var c={eventCollection:a.eventCollection||null,maxAge:86400};"undefined"!=typeof a.filters&&Array.isArray(a.filters)&&a.filters.length>0&&(c.filters=a.filters),"undefined"!=typeof a.groupBy&&null!==a.groupBy&&(c.groupBy=a.groupBy),"undefined"!=typeof a.target_property&&(c.target_property=a.target_property);var d=new Keen.Query(a.analisysType||null,c);d.title=a.title||null,i.push(d)}},this.getCallback=function(){return b},this.getAnalysesProcessor=function(){return this.analysesProcessor},this.getClient=function(){if(null===d&&"function"==typeof Keen){var a=gdn.meta["keenio.projectID"]||!1,b=gdn.meta["keenio.readKey"]||!1;d=new Keen({projectId:a,readKey:b})}return d},this.getConfig=function(a,b){return"undefined"==typeof c[a]?b||null:c[a]},this.getData=function(){return e},this.getDataviz=function(){return null===f&&(f=new Keen.Dataviz,this.loadDatavizConfig(this.getConfig())),f},this.getElement=function(){return h},this.getInterval=function(){return g},this.getRange=function(){return j},this.getQuery=function(){return i},this.getQueryParam=function(a,b){var c=this.getQuery();if(b="undefined"==typeof b?0:parseInt(b),"undefined"==typeof c[b])throw"Invalid query index";var d=c[b];return d.get(a)},this.getTitle=function(){return l},this.getType=function(){return k},this.resetQuery=function(){i=[]},this.setCallback=function(a){if("function"!=typeof this[a])throw"Invalid value for newCallback";return b=this[a],this},this.setAnalysesProcessor=function(a){return this.analysesProcessor=a,this},this.setChartConfig=function(a){if("undefined"!=typeof a)return c=a,this;throw"Invalid newChartConfig"},this.setData=function(a){if("undefined"!=typeof a)return e=a,this;throw"Invalid newData"},this.setElement=function(a){if(a instanceof HTMLElement)return h=a,this;throw"newElement is not an instance of HTMLElement"},this.setInterval=function(a){if("string"==typeof a)return g=a,this;throw"newInterval must be a string"},this.setRange=function(a){if("object"!=typeof a)throw"Invalid newRange";var b=analyticsToolbar.getDefaultRange(),c=a.end||!1,d=a.start||!1;return"object"==typeof c&&c instanceof Date?j.end=c:j.end=b.end,"object"==typeof d&&d instanceof Date?j.start=d:j.start=b.start,this},this.setType=function(a){if("string"==typeof a)return k=a,this;throw"Invalid newType"},this.setTitle=function(a){if("string"==typeof a)return l=a,this;throw"Invalid newTitle"},this.updateQueryParams=function(a){if("object"!=typeof a)throw"Invalid newParams";for(var b=0;b<i.length;b++)i[b].set(a)},this.loadConfig(a)}KeenIOWidget.prototype.metricFormatPercent=function(a){return(100*a).toFixed(1)+"%"},KeenIOWidget.prototype.getMetricMarkup=function(){var a='<div class="metric-value">{data}</div><div class="metric-title">{title}</div>',b=this.getData();this.getTitle();return"number"==typeof b&&(b=Number(b).toLocaleString()),a=a.replace("{data}",b),a=a.replace("{title}",this.getTitle())},KeenIOWidget.prototype.loadConfig=function(a){if("object"!=typeof a)throw"Invalid config";"undefined"!=typeof a.chartConfig&&this.setChartConfig(a.chartConfig),"undefined"!=typeof a.query&&(this.resetQuery(),this.addQuery(a.query)),"undefined"!=typeof a.range&&this.setRange(a.range),"undefined"!=typeof a.title&&this.setTitle(a.title),"undefined"!=typeof a.type&&this.setType(a.type),"undefined"!=typeof a.callback&&this.setCallback(a.callback),"undefined"!=typeof a.queryProcessor&&this.setAnalysesProcessor(new KeenIOAnalysesProcessor(a.queryProcessor))},KeenIOWidget.prototype.loadDatavizConfig=function(a){var b=this.getDataviz(),c=this.getConfig("options",{}),d=this.getConfig("labelMapping");if(b.library("c3"),c3.chart.internal.fn.additionalConfig={axis_y_tick_format:function(a){return a%1===0?a:parseFloat(a).toFixed(2)}},"metric"==this.getType())b.height(this.getConfig("height",85));else{var e=this.getConfig("chartType","area");b.chartType(e);var f={};switch(e){case"area":case"line":f={axis:{x:{type:"timeseries",tick:{count:5,format:"%Y-%m-%d"}}},grid:{x:{show:!0},y:{show:!0}},tooltip_contents:function(a,b,c,d){for(var e='<div class="popover popover-analytics"><div class="title">'+new Date(a[0].x).toLocaleDateString("en-US")+'</div><div class="body">',f=0;f<a.length;f++)0===e.length,a[f]&&(a[f].value||0===a[f].value)&&(e+="<div class='flex popover-row popover-name-"+a[f].id+"'>",e+="<div class='name'>"+a[f].name+"</div>",e+="<div class='value'><span style='color:"+d(a[f].id)+"'>"+c(a[f].value,a[f].ratio,a[f].id,a[f].index)+"</span></div>",e+="</div>");return e+"</div></div>"}};break;case"pie":f={tooltip_contents:function(a,b,c,d){return'<div class="popover popover-analytics"><div class="title">'+a[0].name+'</div><div class="body">'+c(a[0].value,a[0].ratio,a[0].id,a[0].index)+" ("+a[0].value+")</div></div>"}};break;default:throw"Chart type "+e+" options not handled!"}c=$.extend(!0,f,c)}b.chartOptions(c),b.dateFormat("%Y-%m-%d"),b.labelMapping(d)},KeenIOWidget.prototype.formatSeconds=function(a){if("number"!=typeof a)return"-";var b=Math.floor(a/3600),c=Math.floor((a-3600*b)/60),d=Math.floor(a-3600*b-60*c),e="";return b>0?(e+=b.toString()+"h",e+=c.toString()+"m"):(e+=c.toString()+"m",e+=d.toString()+"s"),e},KeenIOWidget.prototype.renderBody=function(){var a=this.getDataviz(),b=a.el();if(!("object"==typeof b&&b instanceof HTMLElement))throw"No valid dataviz element";switch($(b).parent().removeClass("data-loading"),this.getType()){case"metric":b.innerHTML=this.getMetricMarkup(),$(b).trigger("contentLoad");break;default:a.parseRawData({result:this.getData()});var c=a.labels();if(c.length>1)a.stacked(!0);else{var d=$(b).parent(".analytics-widget").index(),e=a.colors();a.colors([e[d%e.length]])}for(var f=0;f<c.length;f++)""===c[f]&&(c[f]="(None)");a.labels(c);var g=a.chartOptions(),h=c3.chart.internal.fn.additionalConfig.tooltip_contents;"undefined"!=typeof g.tooltip_contents&&(c3.chart.internal.fn.additionalConfig.tooltip_contents=g.tooltip_contents),a.view._rendered?a.update():a.render(),c3.chart.internal.fn.additionalConfig.tooltip_contents=h}},KeenIOWidget.prototype.runQuery=function(a){var b=this.getClient(),c=this,d={timeframe:this.getRange()};"metric"!==this.getType()&&$.inArray(this.getConfig("chartType","area"),["area","line"])!==-1&&(d.interval=this.getInterval()),this.updateQueryParams(d);var e=this.getQuery();e.length&&$.each(e,function(a,b){"undefined"!=typeof b.params.filters&&Array.isArray(b.params.filters)&&b.params.filters.length&&$.each(b.params.filters,function(b,d){$.each(d,function(d,f){if("property_callback"===d){if("function"!=typeof KeenIOFilterCallback[f])throw"Invalid filter callback KeenIOFilterCallback."+f;delete e[a].params.filters[b][d],e[a].params.filters[b].property_value=KeenIOFilterCallback[f](c)}})})}),b.run(e,function(b,d){if(null===b){var f=c.getQueryResult(d,e);if(c.setData(f),"function"==typeof a){var g=a.bind(c);g()}}})},KeenIOWidget.prototype.getQueryResult=function(a,b){var c=this.getCallback(),d=[];if("undefined"!=typeof a&&"undefined"!=typeof b){if(Array.isArray(a))$.each(a,function(a,c){var d=null;"undefined"!==b[a].title&&(d=b[a].title),c.title=d});else if("object"==typeof a){var e=null;"undefined"!==b[0].title&&(e=b[0].title),a.title=e}this.analysesProcessor&&(a=this.analysesProcessor.process(a));var f=null;if(Array.isArray(a)&&a.length){if(a.length>1)throw"Multiple analyses detected. Use an AnalysesProcessor to merge them";f=a[0]}else"object"==typeof a&&(f=a);d=f.result}return c&&(d=c(d)),d},KeenIOWidget.prototype.writeContents=function(a,b){var c=this.getClient(),d=this.getDataviz();if(b="undefined"!=typeof b&&!!b,"object"==typeof c){var e=d.el();switch(!b&&("object"==typeof e||e instanceof HTMLElement)||d.el(a),d.view._prepared===!1&&d.prepare(),$(a).parent().addClass("data-loading"),this.getType()){case"leaderboard":var f=AnalyticsWidget.getIDFromAttribute($(a).parent().attr("id")),g=this.getRange(),h={Start:g.start,End:g.end},i=gdn.url("/analytics/leaderboard/"+f);AnalyticsWidget.popin(a,i,h);break;default:this.runQuery(this.renderBody)}}};
//# sourceMappingURL=keeniowidget.min.js.map