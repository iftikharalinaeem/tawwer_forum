function KeenIOWidget(a){var b=null,c={},d=null,e=[],f=null,g="daily",h=null,i=[],j={end:null,start:null},k=null,l="";this.addQuery=function(a){if(a instanceof Array)for(var b=0;b<a.length;b++)this.addQuery(a[b]);else if("object"==typeof a){var c={eventCollection:a.eventCollection||null,maxAge:86400};"undefined"!=typeof a.filters&&Array.isArray(a.filters)&&a.filters.length>0&&(c.filters=a.filters),"undefined"!=typeof a.groupBy&&null!==a.groupBy&&(c.groupBy=a.groupBy),"undefined"!=typeof a.target_property&&(c.target_property=a.target_property);var d=new Keen.Query(a.analisysType||null,c);d.title=a.title||null,i.push(d)}},this.getCallback=function(){return b},this.getQueryProcessor=function(){return this.queryProcessor},this.getClient=function(){if(null===d&&"function"==typeof Keen){var a=gdn.meta["keenio.projectID"]||!1,b=gdn.meta["keenio.readKey"]||!1;d=new Keen({projectId:a,readKey:b})}return d},this.getConfig=function(a,b){return"undefined"==typeof c[a]?b||null:c[a]},this.getData=function(){return e},this.getDataviz=function(){return null===f&&(f=new Keen.Dataviz,this.loadDatavizConfig(this.getConfig())),f},this.getElement=function(){return h},this.getInterval=function(){return g},this.getRange=function(){return j},this.getQuery=function(){return i},this.getQueryParam=function(a,b){var c=this.getQuery();if(b="undefined"==typeof b?0:parseInt(b),"undefined"==typeof c[b])throw"Invalid query index";var d=c[b];return d.get(a)},this.getTitle=function(){return l},this.getType=function(){return k},this.resetQuery=function(){i=[]},this.setCallback=function(a){if("function"!=typeof this[a])throw"Invalid value for newCallback";return b=this[a],this},this.setQueryProcessor=function(a){return this.queryProcessor=a,this},this.setChartConfig=function(a){if("undefined"!=typeof a)return c=a,this;throw"Invalid newChartConfig"},this.setData=function(a){if("undefined"!=typeof a)return e=a,this;throw"Invalid newData"},this.setElement=function(a){if(a instanceof HTMLElement)return h=a,this;throw"newElement is not an instance of HTMLElement"},this.setInterval=function(a){if("string"==typeof a)return g=a,this;throw"newInterval must be a string"},this.setRange=function(a){if("object"!=typeof a)throw"Invalid newRange";var b=analyticsToolbar.getDefaultRange(),c=a.end||!1,d=a.start||!1;return"object"==typeof c&&c instanceof Date?j.end=c:j.end=b.end,"object"==typeof d&&d instanceof Date?j.start=d:j.start=b.start,this},this.setType=function(a){if("string"==typeof a)return k=a,this;throw"Invalid newType"},this.setTitle=function(a){if("string"==typeof a)return l=a,this;throw"Invalid newTitle"},this.updateQueryParams=function(a){if("object"!=typeof a)throw"Invalid newParams";for(var b=0;b<i.length;b++)i[b].set(a)},this.loadConfig(a)}KeenIOWidget.prototype.divideResult=function(a){var b=[];if(!Array.isArray(a))throw"divideResult requires an array";if(2!==a[0].value.length)throw"divideResult requires exactly two results";for(var c=0;c<a.length;c++){var d;d=a[c].value[1].result>0?parseFloat((a[c].value[0].result/a[c].value[1].result).toFixed(2)):0,b.push({timeframe:a[c].timeframe,value:d})}return b},KeenIOWidget.prototype.divideMetrics=function(a){var b={};if(!Array.isArray(a))throw"divideMetrics requires an array";if(2!==a.length)throw"divideMetrics requires exactly two metric";var c=0;return a[0].value>0&&(c=parseFloat((a[0].value/a[1].value).toFixed(2))),b={category:a[0].category,value:c}},KeenIOWidget.prototype.metricFormatPercent=function(a){return(100*a).toFixed(1)+"%"},KeenIOWidget.prototype.getMetricMarkup=function(){var a='<div class="metric-value">{data}</div><div class="metric-title">{title}</div>',b=this.getData();this.getTitle();return"number"==typeof b&&(b=Number(b).toLocaleString()),a=a.replace("{data}",b),a=a.replace("{title}",this.getTitle())},KeenIOWidget.prototype.loadConfig=function(a){if("object"!=typeof a)throw"Invalid config";"undefined"!=typeof a.chartConfig&&this.setChartConfig(a.chartConfig),"undefined"!=typeof a.query&&(this.resetQuery(),this.addQuery(a.query)),"undefined"!=typeof a.range&&this.setRange(a.range),"undefined"!=typeof a.title&&this.setTitle(a.title),"undefined"!=typeof a.type&&this.setType(a.type),"undefined"!=typeof a.callback&&this.setCallback(a.callback),"undefined"!=typeof a.queryProcessor&&this.setQueryProcessor(new KeenIOQueryProcessor(a.queryProcessor))},KeenIOWidget.prototype.loadDatavizConfig=function(a){var b=this.getDataviz(),c=this.getConfig("options"),d=this.getConfig("labelMapping");"object"==typeof c&&null!==c||(c={}),"object"!=typeof c.axis&&(c.axis={}),"object"!=typeof c.axis.y&&(c.axis.y={tick:{outer:!1,format:function(a){if("number"==typeof a){var b=Math.floor(a);return a===b?a:""}return a}}}),b.library("c3"),"metric"==this.getType()&&b.height(this.getConfig("height",85)),b.chartType(this.getConfig("type","area")),b.chartOptions(c),b.dateFormat("%Y-%m-%d"),b.labelMapping(d)},KeenIOWidget.prototype.formatSeconds=function(a){if("number"!=typeof a)return"-";var b=Math.floor(a/3600),c=Math.floor((a-3600*b)/60),d=Math.floor(a-3600*b-60*c),e="";return b>0?(e+=b.toString()+"h",e+=c.toString()+"m"):(e+=c.toString()+"m",e+=d.toString()+"s"),e},KeenIOWidget.prototype.renderBody=function(){var a=this.getDataviz(),b=a.el();if(!("object"==typeof b&&b instanceof HTMLElement))throw"No valid dataviz element";switch($(b).parent().removeClass("data-loading"),this.getType()){case"metric":b.innerHTML=this.getMetricMarkup(),$(b).trigger("contentLoad");break;default:a.parseRawData({result:this.getData()});var c=a.labels();if(c.length>1)a.stacked(!0);else{var d=$(b).parent(".analytics-widget").index(),e=a.colors();a.colors([e[d%e.length]])}for(var f=0;f<c.length;f++)""===c[f]&&(c[f]="(None)");a.labels(c),a.view._rendered?a.update():a.render()}},KeenIOWidget.prototype.runQuery=function(a){var b=this.getClient(),c=this,d={timeframe:this.getRange()};"metric"!==this.getType()&&(d.interval=this.getInterval()),this.updateQueryParams(d);var e=this.getQuery();b.run(e,function(b,d){if(null===b){var f=c.getQueryResult(d,e);if(c.setData(f),"function"==typeof a){var g=a.bind(c);g()}}})},KeenIOWidget.prototype.getQueryResult=function(a,b){var c=this.getCallback(),d=[];if(this.queryProcessor){var e=this.queryProcessor.getResult(a);"object"==typeof e&&"undefined"!=typeof e.result&&(Array.isArray(e.result)?(d=e.result,d.category=b[0].title):d=e.result)}else if("undefined"!=typeof a&&"undefined"!=typeof b)if(Array.isArray(a)&&a.length>0){var f=a[0].result;if(a.length>=1)if(Array.isArray(f))for(var g=0,h=1;h<f.length;g++,h++){var i=[];i.push({category:b[0].title,result:f[g].value});for(var j=1;j<a.length;j++)i.push({category:b[j].title,result:a[j].result[g].value});d.push({timeframe:f[g].timeframe,value:i})}else for(var g=0;g<a.length;g++)d.push({category:b[g].title,value:a[g].result});else d=f,d.category=b[0].title}else"object"==typeof a&&"undefined"!=typeof a.result&&(Array.isArray(a.result)?(d=a.result,d.category=b[0].title):d=a.result);return c&&(d=c(d)),d},KeenIOWidget.prototype.writeContents=function(a,b){var c=this.getClient(),d=this.getDataviz();if(b="undefined"!=typeof b&&!!b,"object"==typeof c){var e=d.el();switch(!b&&("object"==typeof e||e instanceof HTMLElement)||d.el(a),d.view._prepared===!1&&d.prepare(),$(a).parent().addClass("data-loading"),this.getType()){case"leaderboard":var f=AnalyticsWidget.getIDFromAttribute($(a).parent().attr("id")),g=this.getRange(),h={Start:g.start,End:g.end},i=gdn.url("/analytics/leaderboard/"+f);AnalyticsWidget.popin(a,i,h);break;default:this.runQuery(this.renderBody)}}};
//# sourceMappingURL=keeniowidget.min.js.map