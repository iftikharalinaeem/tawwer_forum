function KeenIOWidget(a){var b=null,c={},d=null,e=[],f=null,g="daily",h=null,i=[],j={end:null,start:null},k=null,l="";this.addQuery=function(a){if(a instanceof Array)for(var b=0;b<a.length;b++)this.addQuery(a[b]);else if("object"==typeof a){var c={eventCollection:a.eventCollection||null,maxAge:86400};"undefined"!=typeof a.filters&&Array.isArray(a.filters)&&a.filters.length>0&&(c.filters=a.filters),"undefined"!=typeof a.groupBy&&null!==a.groupBy&&(c.groupBy=a.groupBy),"undefined"!=typeof a.target_property&&(c.target_property=a.target_property);var d=new Keen.Query(a.analisysType||null,c);d.title=a.title||null,i.push(d)}},this.getCallback=function(){return b},this.getAnalysesProcessor=function(){return this.analysesProcessor},this.getClient=function(){if(null===d&&"function"==typeof Keen){var a=gdn.meta["keenio.projectID"]||!1,b=gdn.meta["keenio.readKey"]||!1;d=new Keen({projectId:a,readKey:b})}return d},this.getConfig=function(a,b){return"undefined"==typeof c[a]?b||null:c[a]},this.getData=function(){return e},this.getDataviz=function(){return null===f&&(f=new Keen.Dataviz,this.loadDatavizConfig(this.getConfig())),f},this.getElement=function(){return h},this.getInterval=function(){return g},this.getRange=function(){return j},this.getQuery=function(){return i},this.getQueryParam=function(a,b){var c=this.getQuery();if(b="undefined"==typeof b?0:parseInt(b),"undefined"==typeof c[b])throw"Invalid query index";var d=c[b];return d.get(a)},this.getTitle=function(){return l},this.getType=function(){return k},this.resetQuery=function(){i=[]},this.setCallback=function(a){if("function"!=typeof this[a])throw"Invalid value for newCallback";return b=this[a],this},this.setAnalysesProcessor=function(a){return this.analysesProcessor=a,this},this.setChartConfig=function(a){if("undefined"!=typeof a)return c=a,this;throw"Invalid newChartConfig"},this.setData=function(a){if("undefined"!=typeof a)return e=a,this;throw"Invalid newData"},this.setElement=function(a){if(a instanceof HTMLElement)return h=a,this;throw"newElement is not an instance of HTMLElement"},this.setInterval=function(a){if("string"==typeof a)return g=a,this;throw"newInterval must be a string"},this.setRange=function(a){if("object"!=typeof a)throw"Invalid newRange";var b=analyticsToolbar.getDefaultRange(),c=a.end||!1,d=a.start||!1;return"object"==typeof c&&c instanceof Date?j.end=c:j.end=b.end,"object"==typeof d&&d instanceof Date?j.start=d:j.start=b.start,this},this.setType=function(a){if("string"==typeof a)return k=a,this;throw"Invalid newType"},this.setTitle=function(a){if("string"==typeof a)return l=a,this;throw"Invalid newTitle"},this.updateQueryParams=function(a){if("object"!=typeof a)throw"Invalid newParams";for(var b=0;b<i.length;b++)i[b].set(a)},this.loadConfig(a)}KeenIOWidget.prototype.metricFormatPercent=function(a){return(100*a).toFixed(1)+"%"},KeenIOWidget.prototype.getMetricMarkup=function(){var a='<div class="metric-value">{data}</div><div class="metric-title">{title}</div>',b=this.getData();this.getTitle();return"number"==typeof b&&(b=Number(b).toLocaleString()),a=a.replace("{data}",b),a=a.replace("{title}",this.getTitle())},KeenIOWidget.prototype.loadConfig=function(a){if("object"!=typeof a)throw"Invalid config";"undefined"!=typeof a.chartConfig&&this.setChartConfig(a.chartConfig),"undefined"!=typeof a.query&&(this.resetQuery(),this.addQuery(a.query)),"undefined"!=typeof a.range&&this.setRange(a.range),"undefined"!=typeof a.title&&this.setTitle(a.title),"undefined"!=typeof a.type&&this.setType(a.type),"undefined"!=typeof a.callback&&this.setCallback(a.callback),"undefined"!=typeof a.queryProcessor&&this.setAnalysesProcessor(new KeenIOAnalysesProcessor(a.queryProcessor))},KeenIOWidget.prototype.loadDatavizConfig=function(a){var b=this.getDataviz(),c=this.getConfig("options"),d=this.getConfig("labelMapping");"object"==typeof c&&null!==c||(c={}),"object"!=typeof c.axis&&(c.axis={}),"object"!=typeof c.axis.y&&(c.axis.y={tick:{outer:!1,format:function(a){if("number"==typeof a){var b=Math.floor(a);return a===b?a:""}return a}}}),b.library("c3"),"metric"==this.getType()&&b.height(this.getConfig("height",85)),b.chartType(this.getConfig("type","area")),b.chartOptions(c),b.dateFormat("%Y-%m-%d"),b.labelMapping(d)},KeenIOWidget.prototype.formatSeconds=function(a){if("number"!=typeof a)return"-";var b=Math.floor(a/3600),c=Math.floor((a-3600*b)/60),d=Math.floor(a-3600*b-60*c),e="";return b>0?(e+=b.toString()+"h",e+=c.toString()+"m"):(e+=c.toString()+"m",e+=d.toString()+"s"),e},KeenIOWidget.prototype.renderBody=function(){var a=this.getDataviz(),b=a.el();if(!("object"==typeof b&&b instanceof HTMLElement))throw"No valid dataviz element";switch($(b).parent().removeClass("data-loading"),this.getType()){case"metric":b.innerHTML=this.getMetricMarkup(),$(b).trigger("contentLoad");break;default:a.parseRawData({result:this.getData()});var c=a.labels();if(c.length>1)a.stacked(!0);else{var d=$(b).parent(".analytics-widget").index(),e=a.colors();a.colors([e[d%e.length]])}for(var f=0;f<c.length;f++)""===c[f]&&(c[f]="(None)");a.labels(c),a.view._rendered?a.update():a.render()}},KeenIOWidget.prototype.runQuery=function(callback){var client=this.getClient(),widget=this,updateParams={timeframe:this.getRange()};"metric"!==this.getType()&&(updateParams.interval=this.getInterval()),this.updateQueryParams(updateParams);var queries=this.getQuery();if(queries.length){var match,that=this,evalFromContext=function(js,context){return function(){return eval(js)}.call(context)};$.each(queries,function(a,b){"undefined"!=typeof b.params.filters&&Array.isArray(b.params.filters)&&b.params.filters.length&&$.each(b.params.filters,function(b,c){$.each(c,function(c,d){if(match=/^eval\((.+)\)$/.exec(c)){delete queries[a].params.filters[b][c];try{queries[a].params.filters[b][match[1]]=evalFromContext(d,that)}catch(e){throw console.debug(e),"Invalid filter evaluation"}}})})})}client.run(queries,function(a,b){if(null===a){var c=widget.getQueryResult(b,queries);if(widget.setData(c),"function"==typeof callback){var d=callback.bind(widget);d()}}})},KeenIOWidget.prototype.getQueryResult=function(a,b){var c=this.getCallback(),d=[];if("undefined"!=typeof a&&"undefined"!=typeof b){if(Array.isArray(a))$.each(a,function(a,c){var d=null;"undefined"!==b[a].title&&(d=b[a].title),c.title=d});else if("object"==typeof a){var e=null;"undefined"!==b[0].title&&(e=b[0].title),a.title=e}this.analysesProcessor&&(a=this.analysesProcessor.process(a));var f=null;if(Array.isArray(a)&&a.length){if(a.length>1)throw"Multiple analyses detected. Use an AnalysesProcessor to merge them";f=a[0]}else"object"==typeof a&&(f=a);d=f.result}return c&&(d=c(d)),d},KeenIOWidget.prototype.writeContents=function(a,b){var c=this.getClient(),d=this.getDataviz();if(b="undefined"!=typeof b&&!!b,"object"==typeof c){var e=d.el();switch(!b&&("object"==typeof e||e instanceof HTMLElement)||d.el(a),d.view._prepared===!1&&d.prepare(),$(a).parent().addClass("data-loading"),this.getType()){case"leaderboard":var f=AnalyticsWidget.getIDFromAttribute($(a).parent().attr("id")),g=this.getRange(),h={Start:g.start,End:g.end},i=gdn.url("/analytics/leaderboard/"+f);AnalyticsWidget.popin(a,i,h);break;default:this.runQuery(this.renderBody)}}};
//# sourceMappingURL=keeniowidget.min.js.map