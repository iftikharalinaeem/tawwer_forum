version: 2.1
orbs:
    core: vanilla/core@2.1
    jobs: vanilla/jobs@1.0
executors:
    sphinx:
        docker:
            - image: circleci/php:7.2.19-fpm-node
            - image: dzsysop/sphinx-vanilla
            - image: mysql:5.7.26
              environment:
                  MYSQL_USER: circleci
                  MYSQL_PASSWORD: ''
                  MYSQL_DATABASE: vanilla_test
                  MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
jobs:
    php_sphinx_setup:
        executor: sphinx
        steps:
            - run:
                    name: Versions
                    command: |
                        php --version
                        composer --version
            - core/checkout
            -   run: ~/workspace/ci-scripts/clone-vanilla.sh
            # We explcitly don't cache dependencies.
            # The cache validation & fetching seems to take longer than fetching from source.
            - *run_composer
            -   persist_to_workspace:
                    root: ~/workspace
                    paths:
                        - repo
                        - ci-scripts
                        - vanilla
    php_sphinx_tests:
        executor: sphinx
        steps:
            - attach_workspace:
                at: ~/workspace
            -   run:
                    name: Test setup
                    command: |
                        cd ~/workspace/vanilla
                        cp ./.circleci/scripts/templates/vanilla/conf/bootstrap.before.php ./conf/bootstrap.before.php
                        cp ~/workspace/repo/.circleci/sphinx/sphinxapi.php ./sphinxapi.php
                        echo $'\nrequire_once("../sphinxapi.php");' | tee -a ./conf/bootstrap.before.php
                        indexer
            - run:
                    name: Prepare MySQL
                    command: ~/workspace/ci-scripts/prepare-mysql.sh
            - run:
                    name: Configuring Hosts
                    command: |
                        # Localhost redirects
                        echo 127.0.0.1 vanilla.test | sudo tee -a /etc/hosts
                        cat /etc/hosts
            -   run:
                    name: APIv2 Tests
                    command: |
                        cd ~/workspace/vanilla
                        ./vendor/bin/phpunit -c phpunit.xml.dist --exclude-group=ignore --testsuite="APIv2" --filter SphinxSearchTest
workflows:
    version: 2
    commit:
        jobs:
            # PHP 7.2 jobs are only nightly until we move upwards on infra.
            - php_sphinx_setup:
                  name: php_sphinx_setup
#            - jobs/php_72_lint
            - php_sphinx_tests:
                  requires:
                      - php_sphinx_setup
#            - jobs/php_72_tests:
#                  requires:
#                      - php_setup
            # JS and browsers
#            - jobs/frontend_setup:
#                  name: frontend_setup
#            - jobs/frontend_lint:
#                  requires:
#                      - frontend_setup
#            - jobs/frontend_typechecker:
#                  requires:
#                      - frontend_setup
#            - jobs/frontend_build:
#                  requires:
#                      - frontend_setup
#            - jobs/frontend_test:
#                  requires:
#                      - frontend_setup
#    nightly:
#        triggers:
#            - schedule:
#                  cron: "0 0 * * *" # Once a day.
#                  filters:
#                      branches:
#                          only:
#                              - master
#        jobs:
#            - jobs/dependency_audit
#            # PHP and serverside
#            - jobs/php_setup:
#                  name: php_setup
#            - jobs/php_72_lint
#            - jobs/php_73_lint
#            - jobs/php_72_tests:
#                  requires:
#                      - php_setup
#            - jobs/php_73_tests:
#                  requires:
#                      - php_setup
#            ## JS & browsers
#            - jobs/frontend_setup:
#                  name: frontend_setup
#            - jobs/frontend_lint:
#                  requires:
#                      - frontend_setup
#            - jobs/frontend_typechecker:
#                  requires:
#                      - frontend_setup
#            - jobs/frontend_build:
#                  requires:
#                      - frontend_setup
#            - jobs/frontend_test:
#                  requires:
#                      - frontend_setup
