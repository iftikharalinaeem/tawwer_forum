version: 2.1
orbs:
    core: vanilla/core@dev:test-kb
    jobs: vanilla/jobs@dev:test-kb
jobs:
    php_sphinx_tests:
        executor: core/sphinx
        steps:
            - attach_workspace:
                at: ~/workspace
            - core/checkout
            - run: ~/workspace/ci-scripts/clone-vanilla.sh
            - run: ~/workspace/ci-scripts/clone-alt-repo.sh internal
            - core/composer_install
            - core/prepare_php_tests
            - core/prepare_sphinx
            - core/run_sphinx_test_suite
    php_knowledge_api_tests:
        executor: core/sphinx
        steps:
            - attach_workspace:
                at: ~/workspace
            - core/checkout
            - run: ~/workspace/ci-scripts/clone-vanilla.sh
            - run: ~/workspace/ci-scripts/clone-alt-repo.sh internal
            - core/composer_install
            - core/prepare_php_tests
            - core/prepare_sphinx
            - run:
                name: APIv2 Tests
                command: |
                    cd ~/workspace/vanilla
                    ./vendor/bin/phpunit -c phpunit.xml.dist --exclude-group=ignore --testsuite="APIv2"
workflows:
    version: 2
    commit:
        jobs:
            - jobs/php_setup:
                  name: php_setup
            - jobs/php_72_lint
            - php_sphinx_tests
            - php_knowledge_api_tests
            # JS and browsers
            - jobs/frontend_setup:
                  name: frontend_setup
            - jobs/frontend_lint:
                  requires:
                      - frontend_setup
            - jobs/frontend_typechecker:
                  requires:
                      - frontend_setup
            - jobs/frontend_build:
                  requires:
                      - frontend_setup
            - jobs/frontend_test:
                  requires:
                      - frontend_setup
    nightly:
        triggers:
            - schedule:
                  cron: "0 0 * * *" # Once a day.
                  filters:
                      branches:
                          only:
                              - master
        jobs:
            - jobs/dependency_audit
            # PHP and serverside
            - jobs/php_setup:
                  name: php_setup
            - jobs/php_72_lint
            - jobs/php_73_lint
            - php_sphinx_tests
            - php_knowledge_api_tests
            - jobs/php_73_tests:
                  requires:
                      - php_setup
            ## JS & browsers
            - jobs/frontend_setup:
                  name: frontend_setup
            - jobs/frontend_lint:
                  requires:
                      - frontend_setup
            - jobs/frontend_typechecker:
                  requires:
                      - frontend_setup
            - jobs/frontend_build:
                  requires:
                      - frontend_setup
            - jobs/frontend_test:
                  requires:
                      - frontend_setup
